# Синхронізовано: 2026-02-08 (v6.0 - Deduplicated & Optimized)
# Protocol definitions → behavior_config.yaml
# Monitoring scrape/eval intervals → prometheus.yml
# Tool routing & intent detection → behavior_config.yaml

# =============================================================================
# GLOBAL MODEL CONFIGURATION
# =============================================================================
# Single source of truth for all models used across the system
# Change defaults here to switch models globally

models:
  # =============================================================================
  # LLM PROVIDER CONFIGURATION
  # =============================================================================
  # Choose ONE provider: "copilot" or "windsurf"
  #
  # === COPILOT (GitHub) ===
  # - API: GitHub Copilot (ghu_ token)
  # - Models:
  #   - gpt-4o
  #   - gpt-4.1
  #   - gpt-5-mini
  #   - grok-code-fast-1
  #   - oswe-vscode-secondary
  # - Setup: python scripts/get_copilot_token.py
  #
  # === WINDSURF (Codeium) ===
  # - API: Windsurf/Codeium (sk-ws- token)
  # - Models:
  #   - deepseek-v3
  #   - deepseek-r1
  #   - swe-1
  #   - swe-1.5
  #   - grok-code-fast-1
  #   - kimi-k2.5
  #   - windsurf-fast
  # - Setup: python tools/get_windsurf_token.py
  #
  # === SWITCHING PROVIDERS ===
  # 1. Change provider: "windsurf" below
  # 2. Update model names to allowed Windsurf models per list above
  # 3. Run: python scripts/setup_dev.py --sync-configs
  #
  # === EXAMPLE WINDSURF CONFIGURATION ===
  # provider: "windsurf"
  # default: "deepseek-v3"
  # reasoning: "deepseek-r1"
  # code_analysis: "deepseek-v3"
  #
  # === PROXY MODE (Optional) ===
  # Both providers can work through local proxy on port 8086:
  #   copilot:  python src/tools/copilot_proxy.py (DELETED - use providers directly)
  #   windsurf: python scripts/windsurf_proxy.py
  # =============================================================================
  
  provider: "copilot"                   # LLM provider: copilot | windsurf

  # Default models for different purposes
  # STRICTLY choose from the allowed lists above.
  default: "gpt-4o"                     # Default LLM for agents
  vision: "gpt-4o"                      # Vision/multimodal tasks
  reasoning: "oswe-vscode-secondary"    # Raptor reasoning
  code_analysis: "grok-code-fast-1"     # Fast coding analysis
  consolidation: "oswe-vscode-secondary" # Memory consolidation (Raptor native)
  
  # Fallbacks (used when primary unavailable)
  fallback: "gpt-4o"                    # Fallback model (most stable)
  
  # Sandbox model (used by mcp_sandbox.py)
  sandbox: "oswe-vscode-secondary"

  # Agents inherit from models.default unless overridden

agents:
  atlas:
    # model: inherited from models.default 
    deep_model: "oswe-vscode-secondary"  # Raptor reasoning and planning
    temperature: 0.7
    max_tokens: 2000                 # Standard chat/task mode
    max_tokens_deep: 12000           # Deep persona mode (increased from 8000)

  tetyana:
    # model: inherited from models.default
    reasoning_model: "gpt-4.1"       # Efficient routing and tool selection
    vision_model: ""             # Vision tasks, set in your config.yaml
    temperature: 0.5
    max_tokens: 2000

  grisha:
    # Three-Phase Verification Architecture:
    # Phase 1: Strategy planning (what to verify, which tools)
    strategy_model: "oswe-vscode-secondary" # Raptor reasoning for strategy
    
    # Phase 2: Tool selection & execution (MCP server interaction)
    # model: inherited from models.default
    
    # Phase 3: Result analysis & verdict
    vision_model: ""             # Vision/multimodal verification, set in your config.yaml
    verdict_model: "oswe-vscode-secondary"  # Raptor verdict reasoning
    
    # General settings
    temperature: 0.3
    max_tokens: 1500
    
    # Two-Phase Verification Sequential-Thinking (Quantum)
    verification_reasoning_model: "oswe-vscode-secondary" # Raptor verdict analysis
    verification_temperature: 0.2          # Low temp for precise reasoning
    verification_max_tokens: 4000          # Sufficient for deep analysis

# =============================================================================
# MCP SERVER CONFIGURATION
# =============================================================================
# Feature flags only. Full server config (command, args, env) → mcp_servers.json
# Server names must match keys in mcp_servers.json exactly.

mcp_enhanced:
  retry_attempts: 3
  connection_timeout: 3600

mcp:
  # === TIER 1: MUST-HAVE (Ядро системи) ===
  # xcodebuild includes 168+ tools: 94 native + 63 macos-use bridge + 11 googlemaps bridge
  # macos_use and googlemaps are NOT separate servers — they are bridged through xcodebuild
  xcodebuild:          { enabled: true }
  filesystem:          { enabled: true }
  sequential_thinking:
    enabled: true
    model: "oswe-vscode-secondary"   # Critical for complex reasoning

  # === TIER 2: HIGH PRIORITY (Рекомендовані) ===
  vibe:                { enabled: true }  # Config → vibe_config.toml
  memory:              { enabled: true }
  graph:               { enabled: true }
  redis:               { enabled: true }
  duckduckgo_search:   { enabled: true }
  golden_fund:         { enabled: true }
  data_analysis:       { enabled: true }
  github:              { enabled: true }
  whisper_stt:         { enabled: true }
  devtools:            { enabled: true }
  tour_guide:          { enabled: true }

  # === TIER 3: ADDITIONAL (Додаткові) ===
  puppeteer:           { enabled: true }
  context7:            { enabled: true }
  react_devtools:      { enabled: true }

  # === TIER 4: SPECIALIZED (Спеціалізовані / Дебаг) ===
  chrome_devtools:     { enabled: true }
  postgres:            { enabled: false }  # Experimental, disabled by default

# =============================================================================
# ORCHESTRATOR CONFIGURATION
# =============================================================================

orchestrator:
  # Timeouts
  task_timeout: 3600
  subtask_timeout: 120
  user_input_timeout: 20
  
  # Recursion control
  max_recursion_depth: 5
  
  # Verification
  validate_failed_steps_with_grisha: false  # Set to true to enable Auditor verification on fail
  recovery_voice_agent: atlas  # Which agent explains the recovery strategy

# =============================================================================
# INTELLIGENT SEGMENTATION CONFIGURATION
# =============================================================================
# LLM-based request segmentation for multi-mode processing

segmentation:
  # Enable/disable intelligent segmentation
  enabled: true
  
  # LLM provider configuration for segmentation
  # Inherits from global models.default if not specified
  llm_provider:
    # Override global provider for segmentation (optional)
    # provider: "copilot"  # copilot | windsurf (inherited from models.provider)
    
    # Override model for segmentation (optional)
    model: "gpt-4.1"           # Model for semantic analysis
    
    # LLM parameters for segmentation
    temperature: 0.1            # Low temperature for consistent segmentation
    max_tokens: 2000            # Sufficient for complex requests
    
    # Tier selection (optional)
    tier: "standard"            # standard | deep (deep for complex reasoning)
  
  # Segmentation strategy and rules
  strategy: "llm_semantic"       # llm_semantic | keyword_fallback
  
  # Limits and constraints
  max_segments: 5              # Maximum segments per request
  min_segment_length: 3        # Minimum words per segment (except chat)
  
  # Segmentation behavior
  rules:
    preserve_context: true      # Use conversation history for context
    maintain_order: true        # Keep original request order
    allow_merging: true         # Merge consecutive similar segments
    priority_weight: 0.3        # Weight for mode priority in sorting
    context_weight: 0.7         # Weight for original order in sorting
  
  # Post-processing and validation
  post_processing:
    enable_refinement: true     # Refine segments after initial split
    allow_context_enrichment: true  # Add context to segments
    validate_segment_integrity: true  # Validate segment quality
    
  # Fallback configuration
  fallback:
    enable_keyword_fallback: true  # Use keyword-based segmentation if LLM fails
    keyword_threshold: 0.6         # Confidence threshold for keyword matching

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

security:
  dangerous_commands:
    - rm -rf
    - mkfs
    - dd if=
    - ":(){ :|:& };:"
  require_confirmation: true

# =============================================================================
# SYSTEM PATHS
# =============================================================================
# Centralized path management for all system components

system:
  # Base directories
  config_root: ${CONFIG_ROOT}
  project_root: ${PROJECT_ROOT}
  home: ${HOME}
  
  # Application directories
  workspace_path: ${CONFIG_ROOT}/workspace
  logs: ${CONFIG_ROOT}/logs
  memory: ${CONFIG_ROOT}/memory
  screenshots: ${CONFIG_ROOT}/screenshots
  cache: ${CONFIG_ROOT}/cache
  temp: /tmp/atlastrinity
  
  # Repository paths
  repository_path: ${PROJECT_ROOT}
  backups: ${PROJECT_ROOT}/backups
  
  # Model directories
  models:
    tts: ${CONFIG_ROOT}/models/tts
    stt: ${CONFIG_ROOT}/models/faster-whisper
    stanza: ${CONFIG_ROOT}/models/stanza
    huggingface: ${CONFIG_ROOT}/models/huggingface

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

logging:
  level: INFO
  max_log_size: 10485760
  backup_count: 5

# =============================================================================
# DATABASE MANAGEMENT CONFIGURATION
# =============================================================================

database_management:
  # SQLite configuration
  sqlite:
    url: sqlite+aiosqlite:///${CONFIG_ROOT}/atlastrinity.db
    
    # Connection settings
    connection:
      pool_size: 5
      pool_recycle: 3600
      echo: false                    # SQL query logging
      
    # Table management
    tables:
      sessions:
        enabled: true
        retention_days: 90           # Auto-delete sessions older than 90 days
        auto_archive: true
        
      tasks:
        enabled: true
        retention_days: 60
        auto_archive: true
        index_golden_path: true      # Index successful strategies
        
      logs:
        enabled: true
        retention_days: 30
        max_size_mb: 500             # Max total log size
        auto_cleanup: true
        
      conversation_summaries:
        enabled: true
        retention_days: 180
        compress_old: true
        
      agents:
        enabled: true
        track_performance: true
        
    # Access control
    access_control:
      read_only_mode: false
      allow_delete: true
      require_backup_before_delete: true
      
    # Backup settings
    backup:
      enabled: true
      auto_backup_on_shutdown: true
      auto_backup_frequency: daily   # daily | weekly | never
      backup_location: ${PROJECT_ROOT}/backups/databases
      max_backups: 7                 # Keep last 7 backups
      
  # ChromaDB (vector database) configuration
  chromadb:
    path: ${CONFIG_ROOT}/memory/chroma
    
    # Collection settings
    collections:
      atlastrinity_memory:
        enabled: true
        max_vectors: 100000
        distance_metric: cosine      # cosine | euclidean | l2
        
      conversations:
        enabled: true
        max_vectors: 50000
        retention_days: 180
        
      strategies:
        enabled: true
        max_vectors: 10000
        index_golden_path_only: true
        
    # Performance settings
    performance:
      batch_size: 100
      index_rebuild_threshold: 10000 # Rebuild index after N inserts
      cache_size_mb: 256
      
    # Access control
    access_control:
      read_only_mode: false
      allow_delete: true
      require_confirmation_on_clear: true
      
    # Backup settings - uses parent backup_location from SQLite section
    backup:
      enabled: true
      auto_backup_frequency: weekly
      max_backups: 4
      
  # Redis (state management) configuration
  redis:
    url: redis://localhost:6379/0
    
    # Connection settings
    connection:
      db: 0
      max_connections: 10
      socket_timeout: 5
      socket_connect_timeout: 5
      retry_on_timeout: true
      
    # Key namespaces and TTL
    namespaces:
      sessions:
        prefix: "session:"
        ttl_seconds: 86400           # 24 hours
        
      state:
        prefix: "state:"
        ttl_seconds: 7200            # 2 hours
        
      cache:
        prefix: "cache:"
        ttl_seconds: 3600            # 1 hour
        
      locks:
        prefix: "lock:"
        ttl_seconds: 300             # 5 minutes
        
    # Cleanup policy
    cleanup:
      enabled: true
      auto_cleanup_frequency: hourly # hourly | daily | never
      cleanup_expired_keys: true
      
    # Access control
    access_control:
      read_only_mode: false
      allow_flushdb: false           # Prevent accidental flush
      require_confirmation_on_clear: true
      
  # Global database settings
  global:
    # Data retention
    retention:
      enforce_global_retention: true
      min_retention_days: 7          # Minimum retention for any data
      max_retention_days: 365        # Maximum retention
      
    # Integrity checks
    integrity:
      auto_check_on_startup: true
      check_frequency: daily         # daily | weekly | never
      auto_repair: false             # Manual repair only
      
    # Migration settings
    migrations:
      auto_migrate: true             # Auto-apply schema migrations
      backup_before_migration: true
      rollback_on_failure: true
      
    # Monitoring
    monitoring:
      track_query_performance: true
      slow_query_threshold_ms: 1000
      log_slow_queries: true
      
      # Size limits
      max_db_size_gb: 10
      warn_at_size_gb: 8
      
    # Privacy and security
    security:
      encrypt_sensitive_fields: false # Encrypt API keys, tokens
      hash_passwords: true
      sanitize_logs: true            # Remove sensitive data from logs

voice:
  stt:
    model: large-v3                     # Whisper model (large-v3, medium, small)
    device: auto
    language: uk
  tts:
    engine: ukrainian-tts               # TTS engine
    device: cpu
    enabled: true
    force_ukrainian: true               # Forces translation of English text to Ukrainian
    interaction_language_guard: true    # Detects and warns about language mismatch

# =============================================================================
# MONITORING CONFIGURATION
# =============================================================================
# Settings for Prometheus, Grafana, and OpenSearch integration

monitoring:
  # Prometheus configuration (scrape/eval intervals → prometheus.yml)
  prometheus:
    enabled: true
    port: 8001
    
  # Grafana configuration
  grafana:
    enabled: true
    logging_format: json
    log_level: info
    
  # Storage configuration (Defaults to SQLite for standalone binary)
  # OpenSearch is optional for advanced server-based setups
  opensearch:
    enabled: false 
    hosts: ["http://localhost:9200"]
    index_prefix: "atlastrinity"
    
  # OpenTelemetry tracing configuration
  tracing:
    enabled: true
    service_name: "atlastrinity"
    otlp_endpoint: "localhost:4317"
    batch_timeout: 5s
    max_export_batch_size: 512
    
  # ETL Pipeline monitoring
  etl:
    enabled: true
    track_stages: ["scraping", "transformation", "distribution", "indexing"]
    error_thresholds:
      warning: 5
      critical: 10
      
  # Alerting rules (for future implementation)
  alerts:
    high_cpu_usage:
      threshold: 90
      duration: 5m
      severity: warning
      
    high_memory_usage:
      threshold: 85
      duration: 5m
      severity: warning
      
    request_failures:
      threshold: 10
      duration: 1m
      severity: critical
