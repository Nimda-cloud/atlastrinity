# =============================================================================
# AtlasTrinity Behavior Configuration
# =============================================================================
# Single source of truth template. Auto-synced by watch_config.py.
# Version: 2.0.0 (Optimized Config Templates)
# Last Updated: 2026-01-31
# =============================================================================

# =============================================================================
# ADAPTIVE BEHAVIOR CONFIGURATION
# =============================================================================
# Purpose: Centralized decision-making config for behavior_engine.py
# 
# This configuration drives:
# - Intent detection & classification
# - Strategy selection
# - Tool routing
# - Agent coordination
# - Self-healing & escalation
# - Project creation automation
# 
# Related Protocols (Internal Agents):
# - src/brain/data/protocols/self-healing-protocol.md
# - src/brain/data/protocols/create-new-program.md
# - src/brain/data/protocols/*.txt (data, sdlc, search, storage, system_mastery, task, voice)
# 
# Windsurf Agent Workflows:
# - .agent/workflows/github-operations.md (git operations for Windsurf)
# - .agent/workflows/git-setup.md (git identity setup)
# - .agent/workflows/integrity.md (integrity checks)
# =============================================================================

# =============================================================================
# PROTOCOL DEFINITIONS
# =============================================================================
# Agent operational protocols are loaded from src/brain/data/protocols/
# These protocols define behavior rules for Atlas, Tetyana, Grisha, and Vibe.
#
# Protocol Files (loaded via mcp_registry.py):
# - data_protocol.txt         : Data processing, ingestion, hygiene rules
# - sdlc_protocol.txt          : Software development lifecycle (MANDATORY Vibe usage)
# - search_protocol.txt        : Search strategies and data extraction
# - storage_protocol.txt       : Memory schemas and storage locations
# - system_mastery_protocol.txt: System understanding and recursive analysis
# - task_protocol.txt          : Task execution doctrine
# - voice_protocol.txt         : Voice communication rules (Ukrainian only)
# - vibe_docs.txt              : Vibe MCP server documentation
# - create-new-program.md      : Project creation workflow
# - self-healing-protocol.md   : Autonomous recovery procedures
# - system_monitoring_protocol.md: System state verification
#
# Protocol Integration:
# - Loaded at startup via src/brain/mcp_registry.py:load_registry()
# - Injected into agent prompts via src/brain/prompts/ (ATLAS, TETYANA, GRISHA)
# - Atlas uses SDLC_PROTOCOL for development tasks, TASK_PROTOCOL for others
# - All agents receive VOICE_PROTOCOL, DATA_PROTOCOL, SEARCH_PROTOCOL
# =============================================================================

patterns:
  adaptive_behavior:
    web_task_fallback:
      description: 'Fallback to macOS browser automation when web tasks fail repeatedly'
      trigger:
        conditions:
          task_type: web
          repeated_failures: true
        min_confidence: 0.6
      action:
        server: macos-use
        tool: macos-use_fetch_url
        fallback_strategy: browser_automation
      metadata:
        initial_confidence: 0.6
        success_threshold: 0.8
        usage_priority: high

    gui_vision_assist:
      description: 'Use OCR and vision when accessibility tree fails for GUI tasks'
      trigger:
        conditions:
          task_type: gui
          accessibility_failed: true
        min_confidence: 0.7
      action:
        requires_vision: true
        use_ocr: true
        server: macos-use
        tool: macos-use_analyze_screen
      metadata:
        initial_confidence: 0.7
        success_threshold: 0.8
        usage_priority: medium

    permission_escalation:
      description: 'Retry with sudo when permission errors occur'
      trigger:
        conditions:
          error_contains: 'permission denied'
        min_confidence: 0.5
      action:
        retry_with_sudo: true
        confirm_required: true
        server: macos-use
        tool: execute_command
      metadata:
        initial_confidence: 0.5
        success_threshold: 0.7
        usage_priority: medium

    technical_audit_escalation:
      description: 'Perform raw SQL audit of tool_executions when verification artifacts are missing'
      trigger:
        conditions:
          verification_failed: true
          artifact_missing: true
        min_confidence: 0.8
      action:
        server: vibe
        tool: vibe_check_db
        strategy: log_forensics
        sql_template: |
          SELECT te.tool_name, te.arguments, te.result, te.created_at 
          FROM tool_executions te 
          JOIN task_steps ts ON te.step_id = ts.id 
          WHERE ts.sequence_number = '{STEP_NUMBER}' 
          ORDER BY te.created_at DESC LIMIT 5
        max_retries: 2
      metadata:
        initial_confidence: 0.9
        success_threshold: 1.0
        usage_priority: highest
        
    # Parallel Self-Healing Configuration
    parallel_healing:
      enabled: true
      max_concurrent_tasks: 3
      sandbox_validation: true
      auto_retry_threshold: 2
      notification_channel: "message_bus"
      notify_on_start: true
      notify_on_completion: true

# =============================================================================
# INTENT DETECTION & CLASSIFICATION
# =============================================================================
# User request intent classification patterns
# Previously hardcoded in: atlas.py (lines 263-315)
# =============================================================================

intent_detection:
  # Simple conversational greetings
  simple_chat:
    keywords:
      - привіт
      - хай
      - hello
      - hi
      - атлас
      - atlas
      - дякую
      - окей
      - ок
      - 'як справи'
      - 'як твої справи'
    max_words: 6
    intent: chat
    priority: high
    use_deep_persona: false
    requires_semantic_verification: true

  # deep philosophical questions about identity/soul
  philosophical_query:
    keywords:
      - 'хто ти'
      - 'хто ви'
      - 'ти хто'
      - 'що ти'
      - 'як ти себе'
      - 'відчуваєш'
      - 'усвідомлюєш'
      - 'свідомість'
      - 'душа'
      - 'ти людина'
      - 'твоя мета'
      - 'твоє покликання'
      - 'інструмент'
      - 'бот'
      - 'програма'
      - 'код'
      - 'живий'
      - 'місія'
      - 'mission'
      - 'хто тебе створив'
      - 'хто твій батько'
      - 'твоя мета'
    intent: chat
    priority: highest
    use_deep_persona: true
    requires_semantic_verification: true

  # Information queries requiring tool usage
  info_query:
    keywords:
      - погода
      - weather
      - прогноз
      - температура
      - новини
      - news
      - ціна
      - price
      - курс
      - 'який час'
      - 'what time'
      - скільки
      - системн
      - версія
      - version
      - файл
      - file
      - знайди
      - find
      - пошук
      - search
      - покажи
      - шукай
      - 'розкажи про'
      - прочитай
      - документація
      - documentation
      - бібліотека
      - library
      - api
      - 'як використовувати'
      - 'how to use'
    intent: solo_task
    require_tools: true
    priority: medium
    use_deep_persona: false

  # Complex tasks requiring planning
  complex_task:
    indicators:
      min_words: 7
      contains_action_verbs:
        - як
        - чому
        - виправ
        - зроби
        - поясни
        - how
        - why
        - fix
        - explain
        - create
        - створи
    intent: task
    require_planning: true
    use_deep_persona: true
    enable_sequential_thinking: true
    priority: high

  # Repeat/redo commands
  repeat_intent:
    keywords:
      - повтор
      - repeat
      - redo
      - 'останнє завдання'
      - 'last task'
      - 'з самого початку'
    intent: task
    resolve_from_memory: true
    priority: high

# =============================================================================
# TOOL ROUTING CONFIGURATION
# =============================================================================
# Server and tool resolution logic
# Previously hardcoded in: tool_dispatcher.py (lines 21-800)
# =============================================================================

tool_routing:
  # macOS automation
  macos_use:
    synonyms:
      - macos-use_get_clipboard
      - macos-use_set_clipboard
      - macos-use_take_screenshot
      - get_clipboard
      - set_clipboard
      - take_screenshot
      - screenshot
      - clipboard_get
      - clipboard_set
    priority_server: macos-use
    fallback_server: null
    tool_mapping:
      get_clipboard: macos-use_get_clipboard
      set_clipboard: macos-use_set_clipboard
      take_screenshot: macos-use_take_screenshot
      screenshot: macos-use_take_screenshot

  # Browser automation
  browser:
    synonyms:
      - launch_browser
      - open_browser
      - browser_navigate
      - navigate
      - puppeteer_navigate
      - browser_click
      - browser_type
      - browser_scroll
      - screenshot_page
      - get_page_content
    priority_server: puppeteer
    fallback_server: null
    tool_mapping:
      launch_browser: puppeteer_navigate
      open_browser: puppeteer_navigate
      browser_navigate: puppeteer_navigate
      navigate: puppeteer_navigate

  # Vision/OCR analysis
  vision:
    synonyms:
      - macos-use_analyze_screen
      - analyze_screen
      - ocr
      - vision
      - screen_analysis
      - text_recognition
    priority_server: macos-use
    fallback_server: null
    tool_mapping:
      analyze_screen: macos-use_analyze_screen
      ocr: macos-use_analyze_screen
      vision: macos-use_analyze_screen

  # System monitoring
  system_monitor:
    synonyms:
      - macos-use_list_running_apps
      - list_running_apps
      - running_apps
      - list_apps
      - macos-use_list_browser_tabs
      - list_browser_tabs
      - browser_tabs
      - tabs
      - macos-use_list_all_windows
      - list_windows
      - all_windows
      - windows
    priority_server: macos-use
    fallback_server: null
    tool_mapping:
      list_running_apps: macos-use_list_running_apps
      running_apps: macos-use_list_running_apps
      list_apps: macos-use_list_running_apps
      list_browser_tabs: macos-use_list_browser_tabs
      browser_tabs: macos-use_list_browser_tabs
      tabs: macos-use_list_browser_tabs
      list_windows: macos-use_list_all_windows
      all_windows: macos-use_list_all_windows
      windows: macos-use_list_all_windows

  # Terminal/Command execution
  terminal:
    synonyms:
      - terminal
      - bash
      - zsh
      - sh
      - python
      - python3
      - pip
      - pip3
      - cmd
      - run
      - execute
      - execute_command
      - terminal_execute
      - execute_terminal
      - terminal.execute
      - osascript
      - applescript
      - curl
      - wget
      - jq
      - grep
      - git
      - npm
      - npx
      - brew
      - mkdir
      - ls
      - cat
      - rm
      - mv
      - cp
      - touch
      - sudo
    priority_server: macos-use
    fallback_server: null
    tool_mapping:
      terminal: execute_command
      execute: execute_command
      run: execute_command
    routing_rules:
      - pattern: 'git.*'
        server: macos-use
        tool: execute_command
      - pattern: 'npm.*'
        server: macos-use
        tool: execute_command
      - pattern: 'curl.*'
        server: macos-use
        tool: macos-use_fetch_url

  # Filesystem operations
  filesystem:
    synonyms:
      - filesystem
      - fs
      - file
      - files
      - editor
      - directory_tree
      - list_directory
      - read_file
      - write_file
      - tree
    priority_server: filesystem
    fallback_server: macos-use
    tool_mapping:
      filesystem: read_file
      fs: read_file
      file: read_file
    routing_rules:
      - pattern: 'read.*'
        server: filesystem
        tool: read_file
      - pattern: 'write.*'
        server: filesystem
        tool: write_file

  # Browser/Web automation
  # Search engines
  search:
    synonyms:
      - duckduckgo
      - ddg
      - duckduckgo-search
      - duckduckgo_search
      - search_web
      - web_search
      - business_registry_search
    priority_server: duckduckgo-search
    fallback_server: puppeteer
    special_routing:
      business_registry:
        keywords: [єдрпоу, company, registry, youcontrol, opendatabot, бізнес, підприємство]
        server: duckduckgo-search
        tool: business_registry_search
      open_data:
        keywords: [dataset, датасет, data.gov.ua, портал, 'відкриті дані']
        server: duckduckgo-search
        tool: open_data_search
    tool_mapping:
      business_registry_search: business_registry_search
      registry_search: business_registry_search
      company_search: business_registry_search

  # Code assistance (Vibe)
  vibe:
    synonyms:
      - vibe
      - vibe_prompt
      - vibe_ask
      - vibe_analyze_error
      - vibe_smart_plan
      - vibe_code_review
      - vibe_implement_feature
      - vibe_execute_subcommand
      - vibe_list_sessions
      - vibe_session_details
      - vibe_which
      - vibe_get_config
      - vibe_configure_model
      - vibe_set_mode
      - vibe_configure_provider
      - vibe_session_resume
      - vibe_reload_config
      - debug
      - fix
      - implement
      - feature
      - review
      - plan
      - ask
      - question
      - config
      - model
      - provider
      - resume
      - reload
      - mode
    priority_server: vibe
    fallback_server: null
    tool_mapping:
      vibe: vibe_prompt
      debug: vibe_analyze_error
      fix: vibe_analyze_error
      implement: vibe_implement_feature
      review: vibe_code_review
      plan: vibe_smart_plan
      ask: vibe_ask

  # Memory/Knowledge graph
  memory:
    synonyms:
      - memory
      - knowledge
      - entity
      - entities
      - observation
      - observations
      - fact
      - recall
      - remember
      - store_fact
      - add_memory
      - relationship
      - relation
      - create_entities
      - add_observations
    priority_server: memory
    fallback_server: null
    tool_mapping:
      create_entities: create_entities
      add_observations: add_observations
      search: search
    routing_rules:
      - pattern: 'search.*'
        server: memory
        tool: search
      - pattern: '.*entities.*'
        server: memory
        tool: create_entities
      - pattern: '.*observations.*'
        server: memory
        tool: add_observations

  # Productivity (Notes, Calendar, Reminders)
  productivity:
    synonyms:
      - notes
      - note
      - notes_get
      - notes_create
      - calendar
      - reminder
      - reminders
    priority_server: macos-use
    fallback_server: null
    tool_mapping:
      notes_get: macos-use_notes_get_content
      notes_create: macos-use_notes_create_note
      create_note: macos-use_notes_create_note
      list_notes: macos-use_notes_list_folders
      calendar_events: macos-use_calendar_events
      create_event: macos-use_create_event
      reminders: macos-use_reminders
      create_reminder: macos-use_create_reminder

  # GitHub integration
  github:
    synonyms:
      - github
      - repo
      - repository
      - pull_request
      - pr
      - issue
      - issues
      - gh
      - git_hub
    priority_server: github
    fallback_server: null
    routing_rules:
      - pattern: 'repo_.*'
        server: github
      - pattern: 'issue_.*'
        server: github
      - pattern: 'pr_.*'
        server: github

  # Development tools
  devtools:
    synonyms:
      - devtools
      - lint
      - linter
      - ruff
      - oxlint
      - knip
      - pyrefly
      - check
      - validate
      - health
      - mcp_health
      - inspector
      - diagram
      - architecture
      - update_diagram
      - auto_diagram
    priority_server: devtools
    fallback_server: null
    tool_mapping:
      lint: devtools_lint_python
      check: devtools_check_mcp_health
      validate: devtools_validate_config
      update_diagram: devtools_update_architecture_diagrams
      architecture: devtools_update_architecture_diagrams
      self_heal: devtools_update_architecture_diagrams  # Update diagrams during self-healing
    routing_rules:
      - pattern: 'lint.*python'
        server: devtools
        tool: devtools_lint_python
      - pattern: 'lint.*js'
        server: devtools
        tool: devtools_lint_js
      - pattern: 'update.*diagram'
        server: devtools
        tool: devtools_update_architecture_diagrams
      - pattern: 'architecture.*update'
        server: devtools
        tool: devtools_update_architecture_diagrams
      - pattern: 'self.*heal.*diagram'
        server: devtools
        tool: devtools_update_architecture_diagrams
        context:
          target_mode: internal
          auto_export: true
          
  # Library Documentation (Context7)
  library_docs:
    synonyms:
      - context7
      - c7_search
      - c7_query
      - c7_info
      - documentation
      - docs
      - api_reference
    priority_server: context7
    fallback_server: duckduckgo-search
    tool_mapping:
      c7_search: c7_search
      c7_query: c7_query
      c7_info: c7_info
    routing_rules:
      - pattern: 'c7_.*'
        server: context7
      - pattern: '.*docs.*'
        server: context7
      - pattern: '.*documentation.*'
        server: context7

  # Thinking & Reasoning
  thinking:
    synonyms:
      - sequentialthinking
      - sequential-thinking
      - think
      - reason
    priority_server: sequential-thinking
    fallback_server: null
    tool_mapping:
      sequentialthinking: sequentialthinking
      think: sequentialthinking
      reason: sequentialthinking

  # Data Analysis
  data_analysis:
    synonyms:
      - data_analysis
      - data-analysis
      - analyze_data
      - statistics
      - statistical_analysis
      - data_processing
      - data_visualization
      - data_cleaning
      - pandas
      - csv_analysis
      - excel_analysis
      - read_metadata
      - interpret_column_data
      - run_pandas_code
    priority_server: data-analysis
    fallback_server: null
    tool_mapping:
      analyze_dataset: analyze_dataset
      generate_statistics: generate_statistics
      create_visualization: create_visualization
      data_cleaning: data_cleaning
      data_aggregation: data_aggregation
      read_metadata: read_metadata
      interpret_column_data: interpret_column_data
      run_pandas_code: run_pandas_code
    routing_rules:
      - pattern: 'analyze.*'
        server: data-analysis
        tool: analyze_dataset
      - pattern: 'statistics.*'
        server: data-analysis
        tool: generate_statistics
      - pattern: 'visualiz.*'
        server: data-analysis
        tool: create_visualization

  # Golden Fund Knowledge Base
  golden_fund:
    synonyms:
      - golden_fund
      - golden-fund
      - goldenfund
      - knowledge_base
      - kb
      - ingest
      - probe_entity
      - analyze_and_store
      - get_dataset_insights
    priority_server: golden-fund
    fallback_server: null
    tool_mapping:
      search_golden_fund: search_golden_fund
      probe_entity: probe_entity
      ingest_dataset: ingest_dataset
      add_knowledge_node: add_knowledge_node
      analyze_and_store: analyze_and_store
      get_dataset_insights: get_dataset_insights
      store_blob: store_blob
      retrieve_blob: retrieve_blob
    routing_rules:
      - pattern: 'search.*knowledge.*'
        server: golden-fund
        tool: search_golden_fund
      - pattern: 'probe.*'
        server: golden-fund
        tool: probe_entity
      - pattern: 'ingest.*'
        server: golden-fund
        tool: ingest_dataset

  # XcodeBuild - iOS/macOS Development Automation
  xcodebuild:
    synonyms:
      - xcodebuild
      - xcode
      - ios_development
      - macos_development
      - build_project
      - run_tests
      - simulator
      - ios_simulator
      - device_deployment
      - code_coverage
      - archive_project
      - swift_package
      - xcode_logs
      - xcode_build
      - ios_app
      - macos_app
    priority_server: xcodebuild
    fallback_server: macos-use
    tool_mapping:
      build_project: xcodebuild_build_project
      run_tests: xcodebuild_run_tests
      list_simulators: xcodebuild_list_simulators
      boot_simulator: xcodebuild_boot_simulator
      install_app: xcodebuild_install_app
      launch_app: xcodebuild_launch_app
      analyze_logs: xcodebuild_analyze_logs
      get_coverage: xcodebuild_get_coverage
      archive_project: xcodebuild_archive_project
      clean_build: xcodebuild_clean_build
    routing_rules:
      - pattern: 'build.*project.*'
        server: xcodebuild
        tool: xcodebuild_build_project
      - pattern: 'run.*tests.*'
        server: xcodebuild
        tool: xcodebuild_run_tests
      - pattern: '.*simulator.*'
        server: xcodebuild
        tool: xcodebuild_list_simulators
      - pattern: 'archive.*'
        server: xcodebuild
        tool: xcodebuild_archive_project
      - pattern: 'analyze.*logs.*'
        server: xcodebuild
        tool: xcodebuild_analyze_logs
      - pattern: 'coverage.*'
        server: xcodebuild
        tool: xcodebuild_get_coverage

  # Google Maps & Location Services
  googlemaps:
    synonyms:
      - maps
      - location
      - directions
      - route
      - traffic
      - streetview
      - street_view
      - static_map
      - geocode
      - elevation
      - place
      - places
      - interactive_search
      - search_bar
      - search_map
    priority_server: googlemaps
    fallback_server: macos-use
    tool_mapping:
      street_view: maps_street_view
      static_map: maps_static_map
      directions: maps_directions
      route: maps_directions
      traffic: maps_distance_matrix
      geocode: maps_geocode
      search_places: maps_search_places
      place_details: maps_place_details
      elevation: maps_elevation
      interactive_search: maps_open_interactive_search
      search_bar: maps_open_interactive_search
    routing_rules:
      - pattern: 'maps_.*'
        server: googlemaps
      - pattern: '.*location.*'
        server: googlemaps
        tool: maps_geocode
      - pattern: '.*route.*'
        server: googlemaps
        tool: maps_directions
      - pattern: '.*traffic.*'
        server: googlemaps
        tool: maps_distance_matrix
      - pattern: '.*search.*bar.*'
        server: googlemaps
        tool: maps_open_interactive_search
      - pattern: '.*interactive.*'
        server: googlemaps
        tool: maps_open_interactive_search

# =============================================================================
# TASK CLASSIFICATION
# =============================================================================
# Task type detection and recommended server selection
# Previously hardcoded in: mcp_registry.py (lines 216-298)
# =============================================================================

task_classification:
  gui_tasks:
    keywords: [gui, click, type, window, app, screen]
    recommended_servers: [macos-use]
    priority: tier1

  terminal_tasks:
    keywords: [terminal, command, shell, bash]
    recommended_servers: [macos-use]
    priority: tier1

  file_tasks:
    keywords: [file, read, write, directory]
    recommended_servers: [filesystem, macos-use]
    priority: tier1

  web_tasks:
    keywords: [search, web, internet, google, find, browser, navigate, automation, scrape, react]
    recommended_servers: [duckduckgo-search, puppeteer, macos-use, react-devtools, googlemaps]
    priority: tier2

  location_tasks:
    keywords: [де, адреса, карта, мапа, маршрут, пробки, трафік, затори, улица, вулиця, street, location, directions, traffic]
    recommended_servers: [googlemaps, macos-use]
    priority: tier2

  react_tasks:
    keywords: [react, fiber, component, props, hooks, state, redux, props]
    recommended_servers: [react-devtools, chrome-devtools, vibe]
    priority: tier2
    description: Deep React introspection and debugging

  calendar_tasks:
    keywords: [calendar, event, meeting]
    recommended_servers: [macos-use]
    priority: tier2

  reminder_tasks:
    keywords: [reminder, todo, task]
    recommended_servers: [macos-use]
    priority: tier2

  note_tasks:
    keywords: [note, notes]
    recommended_servers: [macos-use]
    priority: tier2

  email_tasks:
    keywords: [mail, email]
    recommended_servers: [macos-use]
    priority: tier2

  git_tasks:
    keywords: [git, commit, push, pull, branch]
    recommended_servers: [macos-use]
    priority: tier2

  github_tasks:
    keywords: [github, repository, issue, pr]
    recommended_servers: [github, macos-use]
    priority: tier2

  ios_development_tasks:
    keywords: [xcode, ios, macos, simulator, build, xcodeproj, xcworkspace, swift, swiftui, objective-c, cocoapods, carthage, spm, testflight, app_store]
    recommended_servers: [xcodebuild, macos-use]
    priority: tier2
    description: iOS/macOS app development, building, testing, and deployment

  voice_tasks:
    keywords: [voice, audio, transcribe, stt, speech]
    recommended_servers: [whisper-stt]
    priority: tier2

  debug_tasks:
    keywords: [debug, error, fix, analyze]
    recommended_servers: [vibe, sequential-thinking, redis]
    priority: tier2

  code_tasks:
    keywords: [code, review, refactor]
    recommended_servers: [vibe]
    priority: tier2

  thinking_tasks:
    keywords: [think, reason, complex, decision]
    recommended_servers: [sequential-thinking]
    priority: tier3

  time_tasks:
    keywords: [time, clock, date]
    recommended_servers: [macos-use]
    priority: tier2

  fetch_tasks:
    keywords: [fetch, url, http, download]
    recommended_servers: [macos-use]
    priority: tier2

  memory_tasks:
    keywords: [memory, recall, remember, fact, knowledge, observation]
    recommended_servers: [memory]
    priority: tier1

  graph_tasks:
    keywords: [graph, visualize, diagram, mermaid, map, relationship]
    recommended_servers: [graph, memory]
    priority: tier3

  state_tasks:
    keywords: [state, session, persistence, restart, recovery]
    recommended_servers: [redis]
    priority: tier3

  lint_tasks:
    keywords:
      [
        lint,
        ruff,
        oxlint,
        check_code,
        integrity,
        health,
        inspect_server,
        validate_config,
        knip,
        dead_code,
      ]
    recommended_servers: [devtools]
    priority: tier2

  data_analysis_tasks:
    keywords: [data, analysis, statistics, pandas, csv, excel, visualization, chart, aggregate, clean]
    recommended_servers: [data-analysis, golden-fund]
    priority: tier2

  knowledge_base_tasks:
    keywords: [knowledge, ingest, probe, entity, golden, fund, insights, dataset]
    recommended_servers: [golden-fund, memory]
    priority: tier2

# =============================================================================
# STRATEGY SELECTION
# =============================================================================
# Dynamic strategy selection based on task type and context
# Previously hardcoded in: adaptive_behavior.py (get_strategy_recommendation)
# =============================================================================

strategy_selection:
  web_task:
    has_browser: puppeteer-first
    no_browser: macos-use-chrome
    default: macos-use-chrome

  file_task:
    allowed_path: filesystem-direct
    restricted_path: macos-use-finder
    default: filesystem-direct

  code_task:
    error_present: vibe-aggressive
    no_error: vibe-conservative
    default: vibe-conservative

  gui_task:
    complex_ui: vision-assisted
    simple_ui: accessibility-tree
    default: accessibility-tree

# =============================================================================
# ENGINE CONFIGURATION
# =============================================================================

engine:
  # Hot reload settings
  hot_reload_enabled: true
  config_watch_interval_seconds: 5

  # Performance optimization
  cache_enabled: true
  cache_ttl_seconds: 1800 # 30 minutes

  # Pattern matching
  pattern_confidence_threshold: 0.6
  max_pattern_evaluations_per_request: 10

  # Logging
  log_decisions: true
  log_level: INFO

# =============================================================================
# ADVANCED ORCHESTRATOR SETTINGS
# =============================================================================
# Deep customization of system behavior and decision-making logic

advanced:
  # ---------------------------------------------------------------------------
  # RECURSION AND DEPTH CONTROL
  # ---------------------------------------------------------------------------
  recursion:
    max_depth: 5                      # Maximum sub-task nesting levels
    max_iterations_per_level: 3       # Max retry attempts at each level
    depth_warning_threshold: 3        # Warn user when depth exceeds this
    
    # Auto-flatten: Prevent deep nesting by converting to sequential steps
    auto_flatten_enabled: true
    auto_flatten_depth: 4
  
  # ---------------------------------------------------------------------------
  # DEVIATION TOLERANCE
  # ---------------------------------------------------------------------------
  # Control how strictly system follows the planned strategy
  
  deviation:
    # Tolerance levels
    strict_mode: false                # If true, no deviation from plan allowed
    tolerance_level: moderate         # loose | moderate | strict
    
    # Deviation triggers
    allow_deviation_on:
      repeated_failures: true         # Allow after N failures
      failure_threshold: 2            # N failures before deviation
      
      low_confidence: true            # Allow when confidence < threshold
      confidence_threshold: 0.4
      
      explicit_user_request: true     # Always allow on user command
      
      stuck_detection: true           # Auto-deviate when stuck
      stuck_threshold_seconds: 120
    
    # Deviation strategies
    deviation_strategies:
      - name: adaptive_replanning      # Replan with Atlas
        priority: high
        trigger_on: [repeated_failures, stuck_detection]
        
      - name: vibe_escalation          # Escalate to Vibe for debugging
        priority: medium
        trigger_on: [repeated_failures, low_confidence]
        
      - name: simpler_approach         # Try simpler alternative
        priority: low
        trigger_on: [stuck_detection]
  
  # ---------------------------------------------------------------------------
  # VIBE ESCALATION POLICY
  # ---------------------------------------------------------------------------
  # When and how to escalate to Vibe for help
  
  vibe_escalation:
    enabled: true
    
    # Automatic escalation triggers
    auto_escalate_after_tetyana_failures: 3  # Escalate after N Tetyana failures
    auto_escalate_on_critical_error: true    # Immediate escalation on critical errors
    
    # Vibe Optimization Parameters
    vibe_auto_fix: true                      # Whether Vibe should automatically apply fixes
    vibe_quality_checks: true                # Run quality checks (lint/syntax) after Vibe changes
    vibe_max_iterations: 3                   # Max review/fix loops for complex tasks
    vibe_code_style: "ruff"                  # Preferred linter/style checker
    
    # Escalation types
    escalation_types:
      debugging:
        enabled: true
        trigger: error_analysis_needed
        vibe_tool: vibe_analyze_error
        
      code_review:
        enabled: true
        trigger: code_quality_concern
        vibe_tool: vibe_code_review
        post_action:
          update_diagram: true  # Update diagram after review
          server: devtools
          tool: devtools_update_architecture_diagrams
        
      architecture_help:
        enabled: true
        trigger: architectural_decision
        vibe_tool: vibe_smart_plan
        context:
          include_diagrams: true  # Pass diagram content to Vibe
          diagram_paths: ${paths.diagrams.internal_docs}
        post_action:
          update_diagram: true
          server: devtools
          tool: devtools_update_architecture_diagrams
      
      self_healing:
        enabled: true
        trigger: system_error_detected
        vibe_tool: vibe_analyze_error
        context:
          include_diagrams: true
          include_git_status: true
          github_token: ${paths.github.token_env_var}
        post_action:
          update_diagram: true
          commit_changes: true  # Automatic with agent approval
          use_github_mcp: true
          agent_approval:
            enabled: true
            grisha_must_verify: true  # Grisha перевіряє перед commit
            user_approval: false  # Користувач не бере участь в автоматичних процесах
    
    # Cooldown to prevent spam
    cooldown_seconds: 30
    max_escalations_per_session: 5

  
  # ---------------------------------------------------------------------------
  # RETRY AND RECOVERY POLICIES
  # ---------------------------------------------------------------------------
  
  retry:
    # Global retry settings
    max_retries_per_step: 3
    exponential_backoff: true
    backoff_multiplier: 2.0
    max_backoff_seconds: 60
    
    # Retry strategies by error type
    strategies:
      network_error:
        max_retries: 5
        backoff_seconds: 5
        
      permission_error:
        max_retries: 2
        escalate_to_sudo: true
        require_user_confirmation: true
        
      resource_unavailable:
        max_retries: 3
        wait_for_resource: true
        timeout_seconds: 30
        
      llm_rate_limit:
        max_retries: 10
        exponential_backoff: true
        backoff_base: 10
  
  # ---------------------------------------------------------------------------
  # TECHNICAL HELPERS
  # ---------------------------------------------------------------------------
  # Enhanced inference and fallback logic
  
  helpers:
    # Tool inference from arguments
    tool_inference:
      enabled: true
      confidence_threshold: 0.7
      
      # Inference rules (helper для _infer_tool_from_args)
      inference_patterns:
        vibe_keywords: [vibe, debug, analyze, review]
        gui_keywords: [click, type, press, screenshot, scroll]
        filesystem_keywords: [read, write, list, save, delete, file, path]
        browser_keywords: [browser, puppeteer, navigate, google, search, web]
        terminal_keywords: [command, cmd, execute, run, shell]
    
    # Intent fallback classification
    intent_fallback:
      enabled: true
      fallback_to_chat_on_uncertainty: true
      uncertainty_threshold: 0.5
      
    # Model selection helpers
    model_selection:
      auto_select_vision_model: true    # Auto-switch to vision model when image present
      auto_select_code_model: true      # Use code_analysis model for code tasks
      prefer_fast_models_for_simple: true # Use fallback for simple tasks
  
  # ---------------------------------------------------------------------------
  # STRATEGY SEQUENCE SETTINGS
  # ---------------------------------------------------------------------------
  # Advanced control over multi-agent strategy execution
  
  strategy:
    # Planning phase
    planning:
      require_atlas_approval: false   # Require user approval of plan
      min_plan_quality_score: 0.6     # Minimum quality to proceed
      replan_on_low_quality: true     # Auto-replan if quality low
      
    # Execution phase
    execution:
      parallel_execution: false       # Execute steps in parallel (experimental)
      max_parallel_steps: 2
      
      # Step timeout management
      step_timeout_strategy: adaptive # fixed | adaptive
      base_step_timeout: 120          # Base timeout in seconds
      timeout_multiplier_on_retry: 1.5
      
    # Verification phase
    verification:
      require_grisha_audit: false     # Require Grisha verification
      audit_frequency: on_failure     # always | on_failure | never
      quality_threshold: 0.7          # Minimum quality to pass
      
      # NEW: Two-Phase Sequential-Thinking Verification
      two_phase_verification:
        enabled: true                 # Use enhanced logical verification
        phase1_thoughts: 3            # Sequential-thinking iterations for goal analysis
        phase2_thoughts: 4            # Sequential-thinking iterations for verdict formation
        single_success_rule: true     # Allow 1 successful tool to verify step
        fallback_to_mechanical: true  # Use old logic if sequential-thinking fails
        empty_results_as_error: true  # Treat empty results in info-tasks as errors
        max_tools_per_verification: 4 # Maximum verification tools to execute
  
  # ---------------------------------------------------------------------------
  # MEMORY AND LEARNING
  # ---------------------------------------------------------------------------
  
  learning:
    # Automatic pattern learning
    auto_learn_patterns: true
    min_pattern_occurrences: 3        # Learn pattern after N occurrences
    pattern_confidence_boost: 0.1     # Confidence increase per success
    
    # Memory persistence
    remember_successful_strategies: true
    remember_failed_strategies: true
    consolidation_frequency: nightly  # nightly | weekly | disabled
    
    # Context retention
    max_conversation_context: 25      # Messages to keep in context
    compress_old_context: true        # Compress context after N messages
    compression_threshold: 50

# =============================================================================
# MODEL-SPECIFIC OVERRIDES
# =============================================================================
# Fine-tune model behavior for specific scenarios

model_overrides:
  # Use different models for specific task types
  task_specific:
    vision_tasks:
      preferred_model: vision        # From models.vision in config.yaml
      fallback_model: default
      
    code_tasks:
      preferred_model: code_analysis
      fallback_model: vibe_default   # Route to Vibe binary
      
    deep_reasoning:
      preferred_model: reasoning
      enable_sequential_thinking: true
      
    simple_chat:
      preferred_model: fallback      # Use faster model for chat
      skip_planning: true

# =============================================================================
# WORKFLOW STAGES CONFIGURATION
# =============================================================================
# Define all execution stages and their behavior parameters

workflow_stages:
  # ---------------------------------------------------------------------------
  # CHAT STAGE
  # ---------------------------------------------------------------------------
  # Simple conversational responses without task execution
  
  chat:
    enabled: true
    description: "Simple conversational chat with Atlas"
    
    # Behavior settings
    use_deep_persona: false          # Use philosophical/deep personality
    require_tools: false             # No MCP tools needed
    skip_planning: true              # No Tetyana/Grisha involved
    skip_memory_save: false          # Still save conversation context
    
    # Triggers (when to use this stage)
    triggers:
      max_words: 6                   # Short requests (< 6 words)
      keywords_present: true         # Matches greeting keywords
      no_action_verbs: true          # No task verbs detected
      
    # Model selection
    preferred_model: fallback        # Use faster model for chat
    
  # ---------------------------------------------------------------------------
  # DEEP CHAT STAGE
  # ---------------------------------------------------------------------------
  # Philosophical/identity conversations with full personality
  
  deep_chat:
    enabled: true
    description: "Deep personality-driven conversations"
    
    # Behavior settings
    use_deep_persona: true           # CRITICAL: Full philosophical mode
    require_tools: false
    skip_planning: true
    include_system_history: true     # Include our shared history
    
    # Triggers
    triggers:
      identity_topics: true          # Questions about Atlas identity
      philosophical_keywords: 
        - "хто ти"
        - "душа"
        - "призначення"
        - "філософія"
        - "who are you"
        - "your purpose"
        - "your soul"
      emotional_topics: true         # Heart-to-heart discussions
      
    # Model selection
    preferred_model: default         # Use full model for depth
    
  # ---------------------------------------------------------------------------
  # SOLO TASK STAGE
  # ---------------------------------------------------------------------------
  # Atlas handles independently with tools (no Tetyana/Grisha)
  
  solo_task:
    enabled: true
    description: "Information tasks Atlas can handle solo"
    
    # Behavior settings
    use_deep_persona: false
    require_tools: true              # Atlas needs tools (search, filesystem)
    skip_planning: true              # No multi-agent planning
    max_execution_time: 30           # Seconds
    
    # Triggers
    triggers:
      info_query_detected: true      # From intent_detection.info_query
      has_required_tools: true       # Atlas has necessary tools
      no_system_changes: true        # No file creation/system control
      
    # Allowed tools for solo tasks
    allowed_tools:
      - search
      - duckduckgo_search
      - read_file
      - list_files
      - memory_search
      - get_time
      - fetch_url
      
    # Model selection
    preferred_model: default
    
  # ---------------------------------------------------------------------------
  # RECALL STAGE
  # ---------------------------------------------------------------------------
  # Memory retrieval from past conversations
  
  recall:
    enabled: true
    description: "Retrieve information from memory/history"
    
    # Behavior settings
    use_deep_persona: false
    require_tools: true              # Need memory tools
    skip_planning: true
    
    # Memory search settings
    memory_search:
      max_results: 5
      min_relevance_score: 0.6
      include_entities: true
      include_conversations: true
      include_strategies: true
      
    # Model selection
    preferred_model: default
    
  # ---------------------------------------------------------------------------
  # STATUS STAGE
  # ---------------------------------------------------------------------------
  # System status and health checks
  
  status:
    enabled: true
    description: "Report system status and metrics"
    
    # Behavior settings
    use_deep_persona: false
    require_tools: true              # Health check tools
    skip_planning: true
    
    # Status components
    report_components:
      - mcp_servers_status
      - active_sessions
      - memory_stats
      - recent_tasks
      - system_metrics
      
    # Model selection
    preferred_model: fallback        # Fast model sufficient
    
  # ---------------------------------------------------------------------------
  # TASK STAGE
  # ---------------------------------------------------------------------------
  # Full multi-agent execution (Atlas → Tetyana → Grisha)
  
  task:
    enabled: true
    description: "Complex tasks requiring planning and execution"
    
    # Behavior settings
    use_deep_persona: true           # Full context for planning
    require_planning: true           # Atlas creates plan
    require_execution: true          # Tetyana executes
    require_verification: false      # Grisha audit (configurable)
    
    # Planning phase
    planning:
      min_steps: 1                   # Minimum plan complexity
      max_steps: 20                  # Maximum steps allowed
      require_approval: false        # User approval needed
      quality_threshold: 0.6
      
    # Execution phase  
    execution:
      allow_recursion: true
      max_recursion_depth: 5         # From advanced.recursion
      adaptive_timeout: true
      base_timeout: 120
      
    # Verification phase
    verification:
      enabled: false                 # Set to true to enable Grisha
      on_failure_only: true
      quality_threshold: 0.7
      
      # Two-Phase Sequential-Thinking Verification (NEW)
      two_phase_verification:
        enabled: true                 # Enhanced logical verification
        phase1_thoughts: 3            # Goal analysis depth
        phase2_thoughts: 4            # Verdict analysis depth
        single_success_rule: true     # 1 success can verify step
        empty_results_as_error: true  # Empty data = failure for info tasks
      
    # Model selection (cascading from task type)
    model_selection:
      planning: default
      execution: default
      verification: default
      
  # ---------------------------------------------------------------------------
  # DEVELOPMENT STAGE
  # ---------------------------------------------------------------------------
  # Software development tasks with Vibe escalation
  
  development:
    enabled: true
    description: "Code development with Vibe assistance"
    
    # Inherits from task stage
    extends: task
    
    # Override settings
    execution:
      prefer_vibe_for_code: true     # Escalate code tasks to Vibe
      vibe_escalation_threshold: 2   # After 2 Tetyana failures
      
    verification:
      enabled: true                  # Always verify code quality
      require_lint_pass: true
      require_tests_pass: false
      
    # Model selection
    model_selection:
      planning: default
      execution: code_analysis
      verification: default
      code_review: vibe_default       # Use Vibe for code review

# =============================================================================
# PATH CONFIGURATION
# =============================================================================
# Centralized path management for all system components

# =============================================================================
# BEHAVIOR-SPECIFIC PATHS
# =============================================================================
# Paths specific to self-healing and behavioral workflows
# Base system paths are defined in config.yaml:system section

paths:
  # Architecture diagrams for self-healing workflows
  diagrams:
    internal_data: ${PROJECT_ROOT}/src/brain/data/architecture_diagrams
    internal_docs: ${PROJECT_ROOT}/.agent/docs
    external_default: architecture_diagram.md
    exports_internal: ${PROJECT_ROOT}/src/brain/data/architecture_diagrams/exports
    exports_external: diagrams
  
  # GitHub integration for self-healing
  github:
    token_env_var: GITHUB_TOKEN
    repository: Nimda-cloud/atlastrinity

# =============================================================================
# BEHAVIORAL PERSONA CONFIGURATION
# =============================================================================
# Define personality traits and response patterns

behavioral_persona:
  # Atlas personality modes
  atlas:
    # Standard mode
    standard:
      tone: professional_friendly
      verbosity: concise
      language: ukrainian
      formality: informal
      
    # Deep persona mode (philosophical)
    deep:
      tone: philosophical_warm
      verbosity: expressive
      include_metaphors: true
      include_history: true
      emotional_intelligence: high
      
  # Tetyana personality  
  tetyana:
    tone: efficient_focused
    verbosity: minimal
    report_style: technical
    
  # Grisha personality
  grisha:
    tone: analytical_precise
    verbosity: detailed
    report_style: audit_report

# =============================================================================
# RESPONSE TEMPLATES
# =============================================================================
# Standardized response patterns for consistency

response_templates:
  # Success messages
  success:
    task_completed: "Завдання успішно виконано."
    plan_created: "План створено ({steps} кроків)."
    verification_passed: "Верифікація пройдена успішно."
    
  # Error messages
  errors:
    no_steps: "Не вдалося створити план виконання."
    planning_failed: "Помилка при плануванні завдання."
    execution_failed: "Помилка при виконанні кроку {step}."
    
  # Status messages
  status:
    analyzing: "Аналізую ваш запит..."
    planning: "Створюю план дій..."
    executing: "Виконую крок {current}/{total}..."
    verifying: "Перевіряю результат..."

# =============================================================================
# SELF-HEALING CONFIGURATION
# =============================================================================
# Advanced self-repair and recovery mechanisms

self_healing:
  # ---------------------------------------------------------------------------
  # AUTOMATIC ERROR RECOVERY
  # ---------------------------------------------------------------------------
  enabled: true
  
  # Recovery strategies priority order
  recovery_strategies:
    - name: retry_with_backoff
      priority: 1
      enabled: true
      max_attempts: 3
      applicable_errors: [network, timeout, temporary]
      
    - name: alternative_tool
      priority: 2
      enabled: true
      try_alternative_server: true
      try_alternative_tool: true
      
    - name: simplify_approach
      priority: 3
      enabled: true
      break_into_smaller_steps: true
      reduce_complexity: true
      
    - name: vibe_consultation
      priority: 4
      enabled: true
      escalate_to_vibe: true
      vibe_tool: vibe_analyze_error
      min_failure_count: 2
      
    - name: atlas_replanning
      priority: 5
      enabled: true
      request_new_plan: true
      include_error_context: true
      
    - name: user_intervention
      priority: 6
      enabled: true
      ask_user_for_help: true
      provide_error_details: true
  
  # ---------------------------------------------------------------------------
  # ERROR ANALYSIS AND DIAGNOSIS
  # ---------------------------------------------------------------------------
  error_analysis:
    enabled: true
    
    # Automatic classification
    classify_errors: true
    error_categories:
      - network_errors        # Connection, timeout
      - permission_errors     # Access denied, sudo needed
      - resource_errors       # File not found, disk full
      - logic_errors          # Wrong approach, invalid state
      - llm_errors           # Rate limit, token overflow
      - tool_errors          # Tool not available, server down
      
    # Root cause analysis
    deep_analysis:
      enabled: true
      use_vibe_for_complex: true
      complexity_threshold: 3      # Use Vibe after 3 failures
      
    # Pattern recognition
    learn_from_errors:
      enabled: true
      store_error_patterns: true
      suggest_prevention: true
  
  # ---------------------------------------------------------------------------
  # PROACTIVE HEALTH MONITORING
  # ---------------------------------------------------------------------------
  health_monitoring:
    enabled: true
    
    # Pre-execution validation
    pre_checks:
      validate_tools_available: true
      check_server_health: true
      verify_permissions: true
      estimate_success_probability: true
      
    # During execution monitoring
    live_monitoring:
      track_step_duration: true
      detect_infinite_loops: true
      monitor_resource_usage: true
      early_failure_detection: true
      
    # Post-execution validation
    post_checks:
      verify_expected_outcome: true
      check_side_effects: true
      validate_data_integrity: true
  
  # ---------------------------------------------------------------------------
  # RECOVERY PERSISTENCE
  # ---------------------------------------------------------------------------
  persistence:
    save_recovery_attempts: true
    database_table: recovery_attempts
    
    # Analytics
    track_success_rate: true
    identify_problematic_tools: true
    recommend_preventive_actions: true

# =============================================================================
# SOFTWARE DEVELOPMENT WORKFLOW
# =============================================================================
# Specialized configuration for code creation and modification

software_development:
  # ---------------------------------------------------------------------------
  # CODE GENERATION SETTINGS
  # ---------------------------------------------------------------------------
  code_generation:
    enabled: true
    
    # Quality standards
    quality:
      require_type_hints: true
      require_docstrings: true
      require_error_handling: true
      max_function_length: 50        # Lines
      max_complexity: 10             # Cyclomatic complexity
      
    # Code style
    style:
      formatter: ruff                # ruff | black
      linter: ruff                   # ruff | pylint
      auto_format: true
      auto_fix_lint: true
      
    # Testing requirements
    testing:
      require_tests: false           # Require tests for new code
      test_framework: pytest         # pytest | unittest
      min_coverage: 80               # Percentage
      
  # ---------------------------------------------------------------------------
  # CODE MODIFICATION WORKFLOW
  # ---------------------------------------------------------------------------
  code_modification:
    enabled: true
    
    # Safety checks
    safety:
      require_backup: true
      git_commit_before: true
      validate_syntax_before: true
      run_tests_after: true
      
    # Modification strategies
    strategies:
      - name: minimal_change
        priority: high
        description: "Make smallest possible change"
        
      - name: refactor_first
        priority: medium
        description: "Refactor before adding features"
        
      - name: test_driven
        priority: medium
        description: "Write tests first, then implement"
        
  # ---------------------------------------------------------------------------
  # CODE REVIEW PROCESS
  # ---------------------------------------------------------------------------
  code_review:
    enabled: true
    
    # Automatic review
    auto_review:
      enabled: true
      use_vibe: true
      vibe_tool: vibe_code_review
      
      # Review criteria
      check_security: true
      check_performance: true
      check_readability: true
      check_best_practices: true
      
    # Review depth
    depth:
      quick_scan: false              # Just lint and format
      standard_review: true          # Security, performance
      deep_audit: false              # Architecture, design patterns
      
    # Grisha verification
    grisha_verification:
      enabled: false                 # Require Grisha audit
      on_critical_changes: true      # Only for critical code
      quality_threshold: 0.8
      
  # ---------------------------------------------------------------------------
  # DEBUGGING WORKFLOW & SELF-HEALING
  # ---------------------------------------------------------------------------
  # Protocol: src/brain/data/protocols/self-healing-protocol.md
  debugging:
    enabled: true
    
    # Debug strategies
    strategies:
      - name: reproduce_error
        priority: 1
        enabled: true
        
      - name: analyze_logs
        priority: 2
        enabled: true
        use_vibe: true
        
      - name: isolate_cause
        priority: 3
        enabled: true
        create_minimal_example: true
        
      - name: fix_and_verify
        priority: 4
        enabled: true
        run_tests_after_fix: true
        
    # Vibe integration with architecture diagrams
    vibe_debugging:
      enabled: true
      auto_escalate_on_complex: true
      
      # Architecture diagram access for self-healing
      diagram_access:
        enabled: true
        internal_paths:
          - ${paths.diagrams.internal_docs}/mcp_architecture_diagram.md
          - ${paths.diagrams.internal_data}/mcp_architecture.md
        external_pattern: '{project_root}/architecture_diagram.md'
        use_for_context: true  # Include diagram in Vibe context
        update_after_fix: true  # Update diagram after successful fix
        
      # GitHub integration for Vibe
      github_integration:
        enabled: true
        use_github_mcp: true  # Use @modelcontextprotocol/server-github
        fallback_to_cli: true  # Fallback to git CLI if MCP unavailable
        token_source: ${paths.github.token_env_var}
        operations:
          read_files: true      # Automatic
          search_code: true     # Automatic
          list_commits: true    # Automatic
          create_branch: true   # Automatic (agent-based approval)
          create_pr: true       # Automatic (agent-based approval if Grisha/Atlas verify)
          push_commits: true    # Automatic (agent-based approval)
        auto_commit_fixes: true  # Automatic with agent verification
        auto_create_issues: true  # Automatic
        # Agent-based approval (not user)
        require_agent_approval:
          enabled: true
          grisha_verifies_atlas: true   # Grisha перевіряє роботу Atlas
          atlas_verifies_tetyana: true  # Atlas перевіряє роботу Tetyana
          user_approval_only_for: []    # Порожній список = користувач не бере участь
        
      complexity_indicators:
          - multiple_failure_attempts
          - unfamiliar_error_message
          - cross_system_issue
        
  # ---------------------------------------------------------------------------
  # ARCHITECTURE DECISIONS
  # ---------------------------------------------------------------------------
  architecture:
    enabled: true
    
    # Decision-making
    decisions:
      consult_vibe_for_design: true
  
  # ---------------------------------------------------------------------------
  # PROJECT CREATION (NEW PROGRAMS)
  # ---------------------------------------------------------------------------
  # Protocol: src/brain/data/protocols/create-new-program.md
  project_creation:
    enabled: true
    
    # Default structures for different project types
    templates:
      python:
        files:
          - README.md
          - requirements.txt
          - .gitignore
          - pyproject.toml
        directories:
          - src/
          - tests/
          - docs/
      
      nodejs:
        files:
          - README.md
          - package.json
          - .gitignore
          - tsconfig.json
        directories:
          - src/
          - tests/
          - docs/
      
      rust:
        files:
          - README.md
          - Cargo.toml
          - .gitignore
        directories:
          - src/
          - tests/
      
      go:
        files:
          - README.md
          - go.mod
          - .gitignore
        directories:
          - cmd/
          - pkg/
          - internal/
    
    # Automated workflow steps
    workflow:
      enabled: true
      steps:
        - initialize_structure    # Create dirs + files
        - setup_git              # Git init + .gitignore
        - generate_diagram       # devtools_update_architecture_diagrams
        - implement_code         # Vibe generates initial code
        - create_tests           # Vibe generates tests
        - create_documentation   # Tetyana writes README
        - verify_quality         # Grisha reviews
        - commit_to_github       # GitHub MCP push (agent-approved)
    
    # Agent coordination
    agents:
      orchestrator: atlas           # Coordinates workflow
      implementer: vibe            # Generates code
      documenter: tetyana          # Writes docs
      verifier: grisha             # Reviews quality
    
    # Automatic features
    features:
      auto_git_init: true          # Initialize git automatically
      auto_github_setup: true      # Setup GitHub remote if token available
      auto_diagram_generation: true # Generate architecture diagram
      auto_tests: true             # Generate basic tests
      auto_documentation: true     # Generate README
    
    # Routing rules for project creation
    triggers:
      - pattern: 'create.*project'
        agent: atlas
        workflow: project_creation
      - pattern: 'new.*program'
        agent: atlas
        workflow: project_creation
      - pattern: 'initialize.*repo'
        agent: atlas
        workflow: project_creation
      - pattern: 'setup.*project'
        agent: atlas
        workflow: project_creation
    
    # When to consult
    consult_triggers:
      - new_component
      - major_refactoring
      - performance_critical
      - security_sensitive
        
    # Design patterns
    patterns:
      suggest_patterns: true
      prefer_simple: true
      avoid_over_engineering: true
      
  # ---------------------------------------------------------------------------
  # DEPENDENCY MANAGEMENT
  # ---------------------------------------------------------------------------
  dependencies:
    # Installation
    auto_install: false              # Manual approval required
    use_venv: true
    prefer_pinned_versions: true
    
    # Version control
    version_strategy: conservative   # conservative | latest | specific
    
    # Security
    check_vulnerabilities: true
    block_known_vulnerabilities: true
    
  # ---------------------------------------------------------------------------
  # DOCUMENTATION GENERATION
  # ---------------------------------------------------------------------------
  documentation:
    enabled: true
    
    # Auto-generate
    auto_generate:
      docstrings: true
      readme: true
      api_docs: false
      
    # Documentation style
    style:
      format: google                 # google | numpy | sphinx
      language: english              # english | ukrainian
      detail_level: standard         # minimal | standard | comprehensive

# =============================================================================
# WORKFLOW AUTOMATION
# =============================================================================
# Deterministic finite state machine definitions for system processes
# Replaces hardcoded sequences in orchestrator.py

# ---------------------------------------------------------------------------
# WORKFLOWS (Finite State Machines)
# ---------------------------------------------------------------------------
workflows:
  # ---------------------------------------------------------------------------
  # SYSTEM STARTUP
  # ---------------------------------------------------------------------------
  startup:
    description: "System initialization sequence"
    on_error: "continue"              # abort | continue | retry
    
    stages:
      - name: "init_services"
        steps:
          - action: "internal.log"
            params: { msg: "AtlasTrinity Brain is waking up...", level: "info" }
            
          - action: "internal.check_services"
            params: { timeout: 60 }
            
          - action: "internal.state_init"
            params: { reset: false }
            
      - name: "load_memory"
        steps: 
          - action: "internal.db_init"
            
          - action: "internal.memory_warmup"
            params: { async_warmup: true }
            
      - name: "final_check"
        steps:
          - action: "internal.log"
            params: { msg: "System initialization complete. Waiting for input.", level: "info" }

  # ---------------------------------------------------------------------------
  # ERROR RECOVERY
  # ---------------------------------------------------------------------------
  error_recovery:
    description: "Autonomous self-healing protocol"
    
    stages:
      - name: "diagnose"
        steps:
          - action: "internal.log"
            params: { msg: "Initiating self-healing protocols...", level: "warning" }
          - action: "internal.check_services"
            params: { timeout: 30 }
          - action: "internal.analyze_error"
            id: "error_analysis"
            
      - name: "attempt_fix"
        steps:
          - if: "${error_analysis.can_auto_fix}"
            then:
              action: "internal.apply_fix"
              params: { fix_id: "${error_analysis.fix_id}" }
            else:
              action: "internal.escalate"
              params: { target: "user" }


# ---------------------------------------------------------------------------
# ORCHESTRATION FLOW (LangGraph Structure)
# ---------------------------------------------------------------------------
orchestration_flow:
  entry_point: "atlas_planning"
  nodes:
    - name: "atlas_planning"
      type: "planner"
      next: "tetyana_execution"
    - name: "tetyana_execution"
      type: "executor"
      conditional_edge:
        evaluator: "should_verify"
        mapping:
          verify: "grisha_verification"
          continue: "tetyana_execution"
          end: "__end__"
    - name: "grisha_verification"
      type: "verifier"
      next: "tetyana_execution"

  rules:
    should_verify:
      - condition: "has_error"
        result: "continue"   # Retry execution
      - condition: "task_completed"
        result: "end"
      - condition: "needs_verification"
        result: "verify"
      - default: "continue"

# ---------------------------------------------------------------------------
# BACKGROUND MONITORING
# ---------------------------------------------------------------------------
background_monitoring:
  mcp_health:
    interval: 60
    auto_restart: true
    max_retries: 5
    backoff_base: 0.5
  
  memory_consolidation:
    enabled: true
    interval: 3600  # 1 hour

# ---------------------------------------------------------------------------
# OUTPUT PROCESSING
# ---------------------------------------------------------------------------
output_processing:
  voice:
    sanitization_rules:
      - pattern: "\\s+"
        replacement: " "
      - pattern: "[`*#_]"
        replacement: "" # Strip markdown
      - pattern: "\\[Thought \\d+\\]:[\\s\\S]*?(?=FINAL RECOMMENDATION|Аналіз:|Analys|\\Z)"
        replacement: "" # Strip internal reasoning
    min_length: 2
    max_length: 5000
