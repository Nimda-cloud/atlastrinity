# Аналіз системи виклику MCP та їх інструментів в AtlasTrinity

## Огляд архітектури

AtlasTrinity використовує **Model Context Protocol (MCP)** для уніфікації доступу до різноманітних інструментів та сервісів. Система побудована на модульній архітектурі з центральним менеджером MCP серверів.

### Ключові компоненти

#### 1. **MCPManager** (`src/brain/mcp/mcp_manager.py`)

- **Призначення**: Центральний менеджер підключень до MCP серверів
- **Функціональність**:
  - Управління постійними з'єднаннями з серверами
  - Автоматичне перепідключення при обриві зв'язку
  - Обробка помилок та логування
  - Безпечне завершення з'єднань
  - Метрики викликів інструментів

#### 2. **ToolDispatcher** (`src/brain/core/orchestration/tool_dispatcher.py`)

- **Призначення**: Централізований диспетчер для виклику інструментів
- **Функціональність**:
  - Резолювання назв інструментів та синонімів
  - Інтелектуальна маршрутизація до відповідних серверів
  - Валідація аргументів та сумісності
  - Нормалізація команд та обгортка CWD
  - Обробка результатів та пост-процесинг

#### 3. **MCP Registry** (`src/brain/mcp/mcp_registry.py`)

- **Призначення**: Єдине джерело правди для всіх MCP серверів та інструментів
- **Функціональність**:
  - Каталог серверів з описами можливостей
  - Схеми інструментів та параметрів
  - Протоколи використання для різних доменів
  - Кешування для швидкого доступу

## Структура MCP серверів

### Тір 1: Основні сервери (Core)

#### **xcodebuild** (Unified Hub)

- **Опис**: Центральний хаб, що об'єднує **168 інструментів** (прецизійний підрахунок).
- **Компоненти**:
  - **Native Xcode (94 інструменти)**:
    - **76 статичних**: Визначені через YAML-маніфести (`manifests/tools/`).
    - **18 динамічних**: Проксуються через `XcodeToolsBridge` з сервісу `mcpbridge` Xcode (контроль IDE).
    - **Область дії**: Орієнтовані на розробку (Simulator/Device). Напр. `tap`, `screenshot`, `hardware_button` діють виключно всередині iOS симулятора.
  - **macOS-use bridge (63 інструменти)**:
    - **Функціонал**: Глобальне управління системою macOS.
    - **Можливості**: `macos-use_window_management` (move/resize вікон), `macos-use_click_and_traverse` (кліки будь-де), `macos-use_vision_ocr`.
    - **Естетика**: Підтримка `showAnimation` та `animationDuration` (рекомендовано 2.5s-4.5s для природного руху миші з зеленим підсвічуванням).
  - **Google Maps bridge (11 інструментів)**: Геодані та візуалізація.
- **Особливість**: Динамічна реєстрація через воркфлоу (напр. активні `simulator` + `session-management` реєструють лише необхідні ~98 інструментів для економії контексту LLM).
- **Технології**: Node.js Proxy, Swift-бінарники (stdio), `XcodeToolsBridgeManager`.

#### **filesystem**

- **Опис**: Офіційний сервер файлових операцій MCP
- **Інструменти**: read_file, write_file, list_directory, search_files
- **Доступ**: Дозволені шляхи (~, /tmp, PROJECT_ROOT)

#### **sequential-thinking**

- **Опис**: Покрокове розв'язання складних задач
- **Інструменти**: sequentialthinking
- **Використання**: Складні рішення, аналіз ризиків, багатокрокова логіка

### Тір 2: Високопріоритетні сервери

#### **vibe** (Mistral AI)

- **Опис**: AI-двигун для кодингу та дебагінгу (18 інструментів)
- **Ключові інструменти**:
  - `vibe_prompt` - загальні запити до AI
  - `vibe_analyze_error` - аналіз помилок
  - `vibe_implement_feature` - реалізація функціоналу
  - `vibe_code_review` - рев'ю коду
  - `vibe_smart_plan` - планування задач
  - `vibe_check_db` - перевірка бази даних
- **Інтеграції**: GitHub, база даних SQLite, архітектурні діаграми

#### **memory**

- **Опис**: Граф знань для персистентної пам'яті
- **Технології**: SQLite + ChromaDB
- **Інструменти**: create_entities, add_observations, search, get_entity

#### **golden-fund**

- **Опис**: База знань Golden Fund (8 інструментів)
- **Функціональність**: Семантичний пошук, аналіз даних, зберігання

### Тір 3: Спеціалізовані сервери

#### **chrome-devtools**

- **Опис**: Автоматизація браузера через Chrome DevTools Protocol
- **Особливості**: Headless режим, ізольоване середовище

#### **puppeteer**

- **Опис**: High-speed браузер для веб-автоматизації
- **Використання**: Веб-пошук, скрапінг даних, взаємодія з сайтами

#### **data-analysis**

- **Опис**: Аналіз даних на основі Pandas (10 інструментів)
- **Формати**: CSV, Excel, JSON, Parquet
- **Інструменти**: analyze_dataset, generate_statistics, create_visualization

## Процес виклику інструментів

### 1. Ініціація виклику

```python
result = await mcp_manager.dispatch_tool(
    tool_name="vibe_prompt",
    arguments={"prompt": "analyze this code"},
    explicit_server=None
)
```

### 2. Маршрутизація в ToolDispatcher

- **Нормалізація назви**: Перетворення синонімів та псевдонімів
- **Резолюція сервера**: Визначення цільового MCP сервера
- **Валідація**: Перевірка сумісності сервер-інструмент
- **Обгортка команд**: Додавання CWD для термінальних команд

### 3. Виконання в MCPManager

- **Отримання сесії**: Створення або використання існуючого з'єднання
- **Виклик інструменту**: `session.call_tool(tool_name, arguments)`
- **Обробка помилок**: Автоматичне перепідключення при обриві
- **Метрики**: Відстеження часу виконання та успішності

### 4. Пост-процесинг

- **Обрізка великих输出**: Захист від переповнення пам'яті
- **Візуальні хуки**: Оновлення стану карт для геоданих
- **Конвертація результатів**: Перетворення SDK об'єктів в словники

## Система синонімів та інтелектуальної маршрутизації

### Категорії синонімів

- **TERMINAL_SYNONYMS**: bash, zsh, execute, run, cmd, git, npm, pip
- **FILESYSTEM_SYNONYMS**: filesystem, fs, file, editor, read_file, write_file
- **VIBE_SYNONYMS**: vibe, debug, fix, implement, review, plan, ask
- **BROWSER_SYNONYMS**: browser, puppeteer, navigate, web_search
- **KNOWLEDGE_SYNONYMS**: memory, knowledge, entity, remember, store_fact

### Інтелектуальний fallback

При невдалому виклику система автоматично пробує еквівалентні інструменти:

```python
# Якщо primary tool несправний, пробує macOS-use еквівалент
equivalents = {
    "click": "macos-use_click_and_traverse",
    "screenshot": "macos-use_take_screenshot",
    "open": "macos-use_open_application_and_traverse"
}
```

## Конфігурація серверів

### Структура конфігурації (`config/mcp_servers.json.template`)

```json
{
  "mcpServers": {
    "server_name": {
      "transport": "stdio",
      "command": "path/to/executable",
      "args": ["--arg1", "--arg2"],
      "env": { "VAR": "value" },
      "connect_timeout": 300,
      "disabled": false,
      "tier": 1,
      "agents": ["atlas", "tetyana", "grisha"]
    }
  }
}
```

### Підстановка змінних

- `${PROJECT_ROOT}` - корінь проєкту
- `${HOME}` - домашня директорія
- `${CONFIG_ROOT}` - директорія конфігурації
- Environment variables: `${VAR_NAME}`

## Безпека та обмеження

### Обробка великих输出

- Обмеження: 200MB на результат інструменту
- Автоматична обрізка з позначкою `[TRUNCATED DUE TO SIZE]`

### Валідація аргументів

- Перевірка типів відповідно до схеми інструменту
- Автозаповнення відсутніх аргументів
- Конвертація типів з обробкою помилок

### Ізоляція процесів

- Кожен MCP сервер в окремому процесі
- Контроль ресурсів через timeout
- Очищення orphan процесів при рестарті

## Моніторинг та метрики

### Відстеження викликів

- Загальна кількість викликів (`_total_calls`)
- Виклики macOS-use (`_macos_use_calls`)
- Час виконання з попередженням для повільних операцій (>5s)
- **Верифікована продуктивність**: Успішна демонстрація на `Activity Monitor` (PID 32777) — Move (200, 200), Resize (1000x700), Natural Mouse (4.5s).

## Повний Реєстр MCP Серверів (Precision Audit)

Нижче наведено повний перелік активних та допоміжних MCP серверів системи Atlas Trinity, категоризованих за рівнями (Tiers) з вказанням точної кількості інструментів та їх призначення.

### **Tier 1: Ядро Системи (Core Infrastructure)**

Сервери, що завантажуються під час старту та забезпечують базове функціонування.

| Сервер         | Статус   | Інструменти | Ключовий Функціонал                                                 |
| :------------- | :------- | :---------: | :------------------------------------------------------------------ |
| **xcodebuild** | Активний |   **168**   | **Центральний Хаб**: 94 Xcode Native, 63 macOS-use, 11 Google Maps. |
| **filesystem** | Активний |     12      | Офіційні операції з файловою системою (безпечний доступ).           |
| **thinking**   | Активний |      1      | Послідовне мислення (`sequential-thinking`) для Grisha.             |

### **Tier 2: Високий Пріоритет (Advanced Intelligence & State)**

Спеціалізовані сервери для розробки, пам'яті та аналізу помилок.

| Сервер            | Статус     | Інструменти | Ключовий Функціонал                                                   |
| :---------------- | :--------- | :---------: | :-------------------------------------------------------------------- |
| **vibe**          | Активний   |   **17**    | Mistral AI CLI: self-healing, smart-planning, feature implementation. |
| **memory**        | Активний   |   **13**    | SQLite + ChromaDB: створення сутностей, спостереження, डेटा-чейни.    |
| **devtools**      | Активний   |   **18**    | Системний аудит: лінтери, здоров'я MCP, Sandbox, MCP Inspector.       |
| **golden-fund**   | Активний   |    **8**    | Глобальна база знань: семантичний пошук, пробінг сутностей.           |
| **duckduckgo**    | Активний   |    **4**    | Веб-пошук без API-ключів, бізнес-реєстри України.                     |
| **data-analysis** | Активний   |    **8**    | Pandas Engine: статистика, візуалізація, очищення даних.              |
| **tour-guide**    | Внутрішній |    **6**    | Синхронізація переміщення агента та карти (Internal).                 |
| **graph**         | Активний   |    **4**    | Візуалізація графа знань (Mermaid.js, JSON).                          |
| **redis**         | Активний   |    **8**    | Обсервабіліті та управління стейтом (L2 cache).                       |
| **whisper-stt**   | Активний   |    **2**    | Voice control: локальна транскрипція (uk/en).                         |

### **Tier 3-4: On-Demand & Specialized**

Сервери, що активуються за необхідності (напр. для вебу або зовнішніх інтеграцій).

| Сервер        | Статус     | Інструменти | Ключовий Функціонал                              |
| :------------ | :--------- | :---------: | :----------------------------------------------- |
| **chrome-dt** | Активний   |     ~10     | Прямий контроль браузера через CDP.              |
| **puppeteer** | Активний   |     ~10     | Headless автоматизація, скріншоти сайтів.        |
| **context7**  | Активний   |      4      | Документація бібліотек та фреймворків.           |
| **github**    | Активний   |     ~20     | Повна інтеграція з API (PRs, Issues, Repo Ops).  |
| **react-dt**  | Активний   |      2      | Інспекція Fiber tree та стану React компонентів. |
| **postgres**  | _Disabled_ |      -      | Експериментальний доступ до PG 17.               |

### **Зведена Статистика Тулсету**

- **Загальна кількість інструментів (Total Capacity)**: ~310+
- **Native Swift/Objective-C (через Xcode Hub)**: 168 (54% від загальної кількості)
- **Python / Node.js Custom Servers**: ~80
- **Official Model Context Protocol Servers**: ~60

---

## Висновки

Система Atlas Trinity побудована за принципом **Unified Hub Architecture**, де `xcodebuild` виступає головним шлюзом для нативних інструментів, а спеціалізовані Custom Servers (Tier 2) забезпечують інтелектуальні функції агентів.

### Health checks

- Періодична перевірка здоров'я серверів
- Автоматичне перепідключення при відмовах
- Спеціальна обробка для vibe сервера

## Інтеграція з агентами

### Ролі агентів

- **Atlas**: Основний агент з доступом до всіх інструментів
- **Tetyana**: Спеціалізується на веб-автоматизації та аналізі
- **Grisha**: Системний адміністратор та DevTools

### Контекстні протоколи

Система включає детальні протоколи використання для різних доменів:

- `vibe_docs.txt` - протокол роботи з Vibe AI
- `voice_protocol.txt` - голосові інтерфейси
- `search_protocol.txt` - пошукові стратегії
- `sdlc_protocol.txt` - життєвий цикл розробки

## Розширення та кастомізація

### Додавання нового MCP сервера

1. Додати конфігурацію в `mcp_servers.json.template`
2. Створити сервер в `src/mcp_server/`
3. Додати опис в `mcp_catalog.json`
4. Оновити синоніми в `ToolDispatcher`
5. Додати протокол використання

### Внутрішні інструменти

Система підтримує нативні інструменти без окремих процесів:

- `tour-guide` - управління віртуальними турами
- `system` - рестарт MCP серверів та додатку

## Висновки

AtlasTrinity реалізує потужну та гнучку систему виклику інструментів через MCP, що забезпечує:

1. **Уніфікований доступ** до різноманітних інструментів через єдиний протокол
2. **Інтелектуальну маршрутизацію** з автоматичним fallback
3. **Масштабованість** через модульну архітектуру
4. **Надійність** з автоматичним відновленням з'єднань
5. **Безпеку** з ізоляцією процесів та валідацією
6. **Моніторинг** з детальними метриками та health checks

Система активно використовується всіма агентами платформи для виконання широкого спектру задач - від файлових операцій до складної AI-допомоги в розробці.
