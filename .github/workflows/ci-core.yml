name: CI Core Pipeline

on:
  push:
    branches: [main, vibe2, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '22'

jobs:
  # ============================================
  # Linting Jobs
  # ============================================

  # ============================================
  # Unified Validation Job
  # ============================================

  validate-codebase:
    name: Lint, Validate & Check Architecture
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0 # Needed for git history analysis in architecture check

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create Virtual Environment & Install Dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt
          # Install extra tools if not in requirements (though they should be)
          .venv/bin/pip install ruff bandit xenon pyrefly safety detect-secrets

      - name: Install Node Dependencies
        run: npm ci

      - name: Run Unified Linting (Lefthook)
        run: npx lefthook run lint:all

      - name: Verify Architecture Diagrams
        run: .venv/bin/python scripts/ci/check_architecture.py

  # ============================================
  # Integration Jobs
  # ============================================

  sandbox-integration:
    name: MCP Sandbox Integration
    runs-on: ubuntu-latest
    needs: [validate-codebase]
    if: github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'run-sandbox')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run MCP Sandbox Test
        env:
          MISTRAL_API_KEY: '${{ secrets.MISTRAL_API_KEY }}'
          COPILOT_API_KEY: '${{ secrets.COPILOT_API_KEY }}'
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        run: |
          # If no API keys, skip gracefully
          if [[ -z "$MISTRAL_API_KEY" && -z "$COPILOT_API_KEY" ]]; then
            echo "⚠️ No AI API keys found. Skipping sandbox test."
            exit 0
          fi

          # Run sandbox test for all servers, chain len 2
          python scripts/mcp_sandbox.py --all --chain 2

  # ============================================
  # Testing Jobs
  # ============================================

  test-python:
    name: Python Tests & Coverage
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-timeout

      - name: Run unit tests with coverage
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=term \
            --junit-xml=pytest-results.xml \
            --timeout=60 \
            -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        with:
          name: coverage-report
          path: |
            coverage.xml
            pytest-results.xml

  # ============================================
  # Build Jobs
  # ============================================

  build-typescript:
    name: Build TypeScript & Electron
    runs-on: ubuntu-latest
    needs: [validate-codebase]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build renderer (Vite)
        run: npm run build:renderer

      - name: Build electron (TypeScript)
        run: npm run build:electron

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-build
          path: dist/

  # ============================================
  # Configuration Validation
  # ============================================

  validate-configs:
    name: Validate MCP & System Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate MCP configuration
        run: python scripts/ci/validate_mcp_config.py

      - name: Check JSON syntax
        run: |
          find . -name "*.json" -not -path "./node_modules/*" -not -path "./dist_venv/*" -exec python -m json.tool {} \; > /dev/null

      - name: Validate package.json
        run: |
          npm install --package-lock-only
          git diff --exit-code package-lock.json || (echo "package-lock.json is out of sync" && exit 1)

  # ============================================
  # Analysis Jobs
  # ============================================

  #  sonar-analysis:
  #    name: SonarQube Analysis
  #    runs-on: ubuntu-latest
  #    needs: [test-python] # Needs coverage report
  #    if: success()
  #    steps:
  #      - name: Checkout
  #        uses: actions/checkout@v4
  #        with:
  #          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
  #          submodules: recursive
  #
  #      - name: Download coverage report
  #        uses: actions/download-artifact@v4
  #        with:
  #          name: coverage-report
  #          path: .
  #
  #      - name: SonarQube Scan
  #        uses: sonarsource/sonarqube-scan-action@master
  #        env:
  #          SONAR_TOKEN: '${{ secrets.SONAR_TOKEN }}'
  #          SONAR_HOST_URL: '${{ vars.SONAR_HOST_URL }}'
  #        continue-on-error: true # Don't fail CI if Sonar fails (e.g. missing secrets)

  # ============================================
  # Status Summary
  # ============================================

  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs:
      - validate-codebase
      - test-python
      - build-typescript
      - validate-configs
      # - sonar-analysis
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.validate-codebase.result }}" != "success" ]] || \
             [[ "${{ needs.test-python.result }}" != "success" ]] || \
             [[ "${{ needs.build-typescript.result }}" != "success" ]] || \
             [[ "${{ needs.validate-configs.result }}" != "success" ]]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          fi

          fi

          echo "✅ All critical CI jobs passed successfully"
